name: iOS E2E with Maestro (iOS 26.1)

on:
  workflow_dispatch:

jobs:
  e2e:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Unzip iOS project
        run: |
          if [ ! -f "ios-test.zip" ]; then
            echo "‚ùå ios-test.zip not found in repo root."
            exit 1
          fi

          rm -rf test || true
          unzip -o ios-test.zip

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Build iOS app for iOS 26.1 Simulator
        run: |
          xcodebuild \
            -project test/test.xcodeproj \
            -scheme test \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,OS=26.1,name=iPhone 17' \
            -derivedDataPath build \
            build

      - name: Boot iOS 26.1 simulator and install app
        run: |
          APP_PATH="$PWD/build/Build/Products/Debug-iphonesimulator/test.app"

          if [ ! -d "$APP_PATH" ]; then
            echo "‚ùå Built app not found at $APP_PATH"
            exit 1
          fi

          DEVICE_UDID=$(xcrun simctl list devices 'iOS 26.1' | awk -F '[()]' '/iPhone 17 / {print $2; exit}')

          if [ -z "$DEVICE_UDID" ]; then
            echo "‚ùå No iPhone 17 on iOS 26.1 found."
            exit 1
          fi

          echo "Booting simulator $DEVICE_UDID ..."
          xcrun simctl boot "$DEVICE_UDID" || true

          echo "Waiting for SpringBoard to be ready..."
          for i in {1..30}; do  # 30 attempts = ¬±60s max
            if xcrun simctl spawn "$DEVICE_UDID" launchctl print system | grep -q "com.apple.SpringBoard"; then
              echo "SpringBoard is running üéâ"
              break
            fi
            sleep 2
            echo "Waiting..."
          done

          echo "Installing app..."
          xcrun simctl install "$DEVICE_UDID" "$APP_PATH"

      - name: Run Maestro flows
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 180000
        run: |
          maestro test ./ios-flow.yaml
