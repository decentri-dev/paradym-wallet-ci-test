name: iOS E2E with Maestro

on:
  workflow_dispatch:

jobs:
  e2e:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      # Pak de Xcode projectmap uit uit test.xcodeproj.zip
      - name: Unzip Xcode project
        run: |
          echo "Current directory:"
          pwd
          echo "Listing files:"
          ls -R

          if [ ! -f "test.xcodeproj.zip" ]; then
            echo "❌ test.xcodeproj.zip not found in repo root."
            exit 1
          fi

          unzip -o test.xcodeproj.zip

          echo "After unzip:"
          ls -R test.xcodeproj || true

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Build iOS app for Simulator
        run: |
          echo "Xcode version:"
          xcodebuild -version

          echo "Available SDKs:"
          xcodebuild -showsdks

          xcodebuild \
            -project test.xcodeproj \
            -scheme test \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build \
            build

          echo "Built products:"
          ls -R build/Build/Products || true

      - name: Print bundle ID
        run: |
            APP_PATH="$PWD/build/Build/Products/Debug-iphonesimulator/test.app"
            echo "Bundle ID:"
            defaults read "$APP_PATH/Info.plist" CFBundleIdentifier

      - name: Run Maestro flows
        run: |
          APP_PATH="$PWD/build/Build/Products/Debug-iphonesimulator/test.app"
          echo "Using APP_PATH=$APP_PATH"

          if [ ! -d "$APP_PATH" ]; then
            echo "❌ app path not found: $APP_PATH"
            ls -R "$PWD/build/Build/Products" || true
            exit 1
          fi

          maestro --version
          maestro test ./ios-flow.yaml --app "$APP_PATH"
