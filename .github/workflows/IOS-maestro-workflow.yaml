name: iOS E2E with Maestro (iOS 26)

on:
  workflow_dispatch:

jobs:
  e2e:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      # Unzip volledige iOS project map (verwacht ios-test.zip -> map 'test/')
      - name: Unzip iOS project
        run: |
          echo "Current directory:"
          pwd
          echo "Files in repo root:"
          ls -R

          if [ ! -f "ios-test.zip" ]; then
            echo "❌ ios-test.zip not found in repo root."
            exit 1
          fi

          # Oude 'test' directory opruimen als die bestaat
          if [ -d "test" ]; then
            echo "Removing existing test directory..."
            rm -rf test
          fi

          unzip -o ios-test.zip

          echo "After unzip (test folder):"
          ls -R test || true

      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Show runtimes and devices (debug)
        run: |
          echo "=== RUNTIMES ==="
          xcrun simctl list runtimes
          echo "=== DEVICES ==="
          xcrun simctl list devices

      - name: Build iOS app for Simulator
        run: |
          echo "Xcode version:"
          xcodebuild -version

          echo "Available SDKs:"
          xcodebuild -showsdks

          echo "Project info:"
          xcodebuild -list -project test/test.xcodeproj

          # Build de app vanuit test/test.xcodeproj met scheme 'test'
          xcodebuild \
            -project test/test.xcodeproj \
            -scheme test \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build \
            build

          echo "Built products:"
          ls -R build/Build/Products || true

      - name: Print bundle ID
        run: |
          APP_PATH="$PWD/build/Build/Products/Debug-iphonesimulator/test.app"
          echo "Using APP_PATH=$APP_PATH"
          if [ ! -d "$APP_PATH" ]; then
            echo "❌ app path not found: $APP_PATH"
            ls -R "$PWD/build/Build/Products" || true
            exit 1
          fi
          echo "Bundle ID:"
          defaults read "$APP_PATH/Info.plist" CFBundleIdentifier || echo "Could not read bundle id"

      - name: Boot iOS 26 simulator and install app
        run: |
          APP_PATH="$PWD/build/Build/Products/Debug-iphonesimulator/test.app"
          echo "Using APP_PATH=$APP_PATH"

          if [ ! -d "$APP_PATH" ]; then
            echo "❌ app path not found: $APP_PATH"
            ls -R "$PWD/build/Build/Products" || true
            exit 1
          fi

          echo "=== AVAILABLE DEVICES (AGAIN) ==="
          xcrun simctl list devices

          # Pak een iPhone met iOS 26.x (26.0, 26.1, etc.)
          DEVICE_UDID=$(xcrun simctl list devices available | awk -F '[()]' '/iPhone 17 .*26\./ {print $2; exit}')
          if [ -z "$DEVICE_UDID" ]; then
            # fallback: elke iPhone met 26.x
            DEVICE_UDID=$(xcrun simctl list devices available | awk -F '[()]' '/iPhone .*26\./ {print $2; exit}')
          fi

          if [ -z "$DEVICE_UDID" ]; then
            echo "❌ No available iOS 26.x iPhone simulator found. See device list above."
            exit 1
          fi

          echo "Using simulator UDID: $DEVICE_UDID"

          # Boot de simulator (als hij al draait is het oké)
          xcrun simctl boot "$DEVICE_UDID" || true

          # Korte wait in plaats van bootstatus die kan hangen
          echo "Waiting a bit for simulator to boot..."
          sleep 25

          # Installeer de app op deze simulator
          echo "Installing app on simulator..."
          xcrun simctl install "$DEVICE_UDID" "$APP_PATH"

      - name: Run Maestro flows
        run: |
          maestro --version
          maestro test ./ios-flow.yaml
